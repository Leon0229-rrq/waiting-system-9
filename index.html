<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>3-3 じゃがバター予約</title>
<style>
body { font-size: 1.2em; padding: 10px; }
</style>
</head>
<body>
<h1>じゃがバター予約</h1>
<p>現在の待ち人数: <span id="queue"></span>人</p>
<p>推定待ち時間: <span id="wait"></span>分</p>

<div id="reservationSection">
  <form id="reserveForm">
    名前: <input type="text" id="name" required><br>
    人数(最大3): <input type="number" id="people" min="1" max="3" required><br>
    <button type="submit">予約する</button>
  </form>
</div>

<div id="myInfo" style="display:none;">
  <p>あなたの受付番号: <span id="myNumber"></span></p>
  <p>予約人数: <span id="myPeople"></span>人</p>
  <p>推定待ち時間: <span id="myWait"></span>分</p>
  <button id="cancelBtn">予約キャンセル</button>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwC6z5-Xeqpe44BI2KjQxRTbryifeOWJjAKTyKMUWSzPD9_7_ITj1OKonqk0_TuFFes/exec";
let myNumber = null;

function loadStatus() {
  fetch(GAS_URL)
    .then(res => res.json())
    .then(data => {
      document.getElementById("queue").textContent = data.queueLength;
      document.getElementById("wait").textContent = data.waitTime;
    });
}

function checkMyReservation(name) {
  fetch(`${GAS_URL}?name=${encodeURIComponent(name)}`)
    .then(res => res.json())
    .then(data => {
      if (data.hasReservation) {
        myNumber = data.number;
        document.getElementById("myNumber").textContent = data.number;
        document.getElementById("myPeople").textContent = data.people;
        document.getElementById("myWait").textContent = data.waitTime;
        document.getElementById("reservationSection").style.display = "none";
        document.getElementById("myInfo").style.display = "block";
      }
    });
}

document.getElementById("reserveForm").addEventListener("submit", e => {
  e.preventDefault();
  const name = document.getElementById("name").value;
  const people = document.getElementById("people").value;
  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({action: "reserve", name, people})
  }).then(res => res.json()).then(r => {
    if (r.status === "success") {
      myNumber = r.number;
      alert(`予約しました。受付番号: ${r.number}`);
      checkMyReservation(name);
      loadStatus();
    } else {
      alert(r.message);
    }
  });
});

document.getElementById("cancelBtn").addEventListener("click", () => {
  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({action: "cancel", id: myNumber})
  }).then(res => res.json()).then(r => {
    if (r.status === "success") {
      alert("キャンセルしました");
      location.reload();
    }
  });
});

loadStatus();
setInterval(loadStatus, 10000);
</script>
</body>
</html>
